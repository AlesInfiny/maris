@page "/announcements/create"

@using DresscaCMS.Announcement.ApplicationCore
@using DresscaCMS.Announcement.ApplicationCore.ApplicationServices
@using DresscaCMS.Web.Extensions
@using Maris.ComponentModel
@using Maris.Core
@using Microsoft.AspNetCore.Components.Authorization

@inject AnnouncementsApplicationService AnnouncementsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<PageTitle>Dressca-CMS - お知らせメッセージ登録</PageTitle>

<div>
    <h3>お知らせメッセージ登録</h3>

    <FluentStack Orientation="Orientation.Vertical" VerticalGap="30">
        <FluentBreadcrumb>
            <FluentBreadcrumbItem>
                <FluentAnchor Href="/" Appearance="Appearance.Hypertext">TOP</FluentAnchor>
                <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
            </FluentBreadcrumbItem>
            <FluentBreadcrumbItem>
                お知らせメッセージ管理
                <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
            </FluentBreadcrumbItem>
            <FluentBreadcrumbItem>
                <FluentAnchor Href="/announcements" Appearance="Appearance.Hypertext">お知らせメッセージ一覧</FluentAnchor>
                <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
            </FluentBreadcrumbItem>
            <FluentBreadcrumbItem>
                お知らせメッセージ登録
            </FluentBreadcrumbItem>
        </FluentBreadcrumb>

        <EditForm EditContext="this.editContext" OnSubmit="@OnRegisterButtonClickAsync" FormName="AnnouncementCreateForm">
            <DataAnnotationsValidator />
            <FluentStack Orientation="Orientation.Vertical">

                <FluentCard AreaRestricted="false">
                    <h4>基本情報</h4>
                    @* お知らせメッセージ登録・ヘッダー部 *@
                    <FluentStack Orientation="Orientation.Horizontal">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="掲載開始日時（日付）" Required="true" />
                            <FluentDatePicker @bind-Value="@this.announcementModel.PostDate" Placeholder="yyyy/MM/dd" />
                            <FluentValidationMessage For="@(() => this.announcementModel.PostDate)" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="掲載開始日時（時刻）" />
                            <FluentTimePicker @bind-Value="@this.announcementModel.PostTime" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="掲載終了日時（日付）" />
                            <FluentDatePicker @bind-Value="@this.announcementModel.ExpireDate" Placeholder="yyyy/MM/dd" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="掲載終了日時（時刻）" />
                            <FluentTimePicker @bind-Value="@this.announcementModel.ExpireTime" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="カテゴリー" />
                            <FluentTextField @bind-Value="@this.announcementModel.Category" Maxlength="128" Style="width: 200px;" />
                            <FluentValidationMessage For="@(() => this.announcementModel.Category)" />
                        </FluentStack>
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentInputLabel Label="表示優先度" Required="true" />
                            <FluentSelect @bind-SelectedOption="@this.announcementModel.DisplayPriority"
                                          Items="@(Enum.GetValues<DisplayPriority>())"
                                          OptionValue="@(p => ((int)p).ToString())"
                                          OptionText="@(p => p.GetDisplayName())"
                                          Width="100px" />
                            <FluentValidationMessage For="@(() => this.announcementModel.DisplayPriority)" />
                        </FluentStack>
                    </FluentStack>
                </FluentCard>
                <FluentStack Orientation="Orientation.Horizontal">
                    <FluentCard AreaRestricted="false">
                        <FluentStack Orientation="Orientation.Vertical">
                            @* お知らせメッセージ登録・お知らせコンテンツアクション部 *@
                            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="20" VerticalAlignment="VerticalAlignment.Top">
                                <h4>お知らせメッセージ</h4>
                                <FluentButton Appearance="Appearance.Accent" OnClick="@this.OnAddLanguageButtonClick">別の言語を追加</FluentButton>
                            </FluentStack>
                            @if (!this.announcementModel.AnnouncementContents.Any())
                            {
                                <p>登録されているお知らせメッセージはありません。</p>
                            }
                            else
                            {
                                @foreach (var content in this.announcementModel.AnnouncementContents.OrderBy(c => c.DisplayOrder))
                                {
                                    <FluentCard AreaRestricted="false" Class="card-with-action">
                                        <FluentButton Appearance="Appearance.Outline" OnClick="@(() => this.OnDeleteContentButtonClick(content.Id))" Class="card-action-button">
                                            <FluentIcon Value="@(new Icons.Regular.Size20.Delete())" Color="@Color.Error" Slot="start" />
                                            削除
                                        </FluentButton>
                                        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                                            <FluentStack Orientation="Orientation.Vertical">
                                                <FluentInputLabel Label="言語" Required="true" />
                                                <FluentSelect @bind-Value="content.LanguageCode" Items="languagePriorities" OptionValue="@(p => p.Code)" OptionText="@(p => p.DisplayName)" />
                                                <FluentValidationMessage For="@(() => content.LanguageCode)" />
                                                <FluentInputLabel Label="タイトル" Required="true" />
                                                <FluentTextField @bind-Value="@content.Title" Maxlength="256" Style="width: 100%;" />
                                                <FluentValidationMessage For="@(() => content.Title)" />
                                                <FluentInputLabel Label="メッセージ" Required="true" />
                                                <FluentTextArea @bind-Value="@content.Message" Maxlength="512" Rows="3" Style="width: 100%;" />
                                                <FluentValidationMessage For="@(() => content.Message)" />
                                                <FluentInputLabel Label="リンク先URL" />
                                                <FluentTextField @bind-Value="@content.LinkedUrl" Maxlength="1024" Placeholder="https://www.example.com" Style="width: 100%;" />
                                                <FluentValidationMessage For="@(() => content.LinkedUrl)" />
                                            </FluentStack>
                                        </FluentStack>
                                    </FluentCard>
                                }
                            }
                        </FluentStack>
                    </FluentCard>
                    @* お知らせメッセージ登録・アクション部 *@
                    <FluentCard Width="400px">
                        <FluentStack Orientation="Orientation.Vertical">
                            <FluentStack Orientation="Orientation.Horizontal">
                                <h4>アクション</h4>
                                @if (this.isSubmitting)
                                {
                                    <FluentProgressRing Width="20px" />
                                }
                            </FluentStack>
                            <FluentValidationSummary Model="@this.announcementModel" />
                            <FluentStack Orientation="Orientation.Vertical" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="30">
                                <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Disabled="@this.isSubmitting">
                                    お知らせメッセージの登録
                                </FluentButton>
                                <FluentAnchor Href="/announcements" Appearance="Appearance.Hypertext">お知らせメッセージ管理画面へ戻る</FluentAnchor>
                            </FluentStack>
                        </FluentStack>
                    </FluentCard>
                </FluentStack>
            </FluentStack>
        </EditForm>
    </FluentStack>
</div>

@code {

    private ValidationMessageStore messageStore = default!;
    private EditContext editContext = default!;
    private bool isSubmitting;
    private readonly AnnouncementCreateViewModel announcementModel = new();
    private readonly LanguagePriorities languagePriorities = new();

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        this.editContext = new EditContext(this.announcementModel);
        this.messageStore = new ValidationMessageStore(this.editContext);

        // 初期表示時に日本語のコンテンツを1件追加
        this.AddContentWithLanguage(Language.Japanese);
    }

    /// <summary>
    /// 別の言語を追加ボタンクリック時の処理
    /// </summary>
    private void OnAddLanguageButtonClick()
    {
        this.AddContentWithLanguage(this.GetNextLanguageCode());
    }

    /// <summary>
    /// 次に追加すべき言語を取得
    /// </summary>
    private Language GetNextLanguageCode()
    {
        var existingLanguages = this.announcementModel.AnnouncementContents.Select(c => c.LanguageCode).ToHashSet();
        var lang = this.languagePriorities.FirstOrDefault(l => !existingLanguages.Contains(l.Code));

        // 全ての言語が追加済みの場合は日本語を返す
        return lang ?? Language.Japanese;
    }

    /// <summary>
    /// 指定された言語コードでコンテンツを追加
    /// </summary>
    private void AddContentWithLanguage(Language language)
    {
        var newContent = new AnnouncementContentCreateViewModel
        {
            Id = Guid.NewGuid(),
            LanguageCode = language.Code,
            DisplayOrder = this.languagePriorities.GetDisplayOrder(language)
        };

        this.announcementModel.AnnouncementContents.Add(newContent);
    }

    /// <summary>
    /// コンテンツ削除ボタンクリック時の処理
    /// </summary>
    private void OnDeleteContentButtonClick(Guid contentId)
    {
        var content = this.announcementModel.AnnouncementContents.FirstOrDefault(c => c.Id == contentId);
        if (content != null)
        {
            this.announcementModel.AnnouncementContents.Remove(content);
        }
    }

    /// <summary>
    /// 登録ボタンクリック時の処理
    /// </summary>
    private async Task OnRegisterButtonClickAsync()
    {
        this.isSubmitting = true;
        this.StateHasChanged();
        try
        {
            this.messageStore.Clear();

            if (!this.editContext.Validate())
            {
                return;
            }

            // 相関チェック
            var offsetMinutes = await this.GetOffsetAsync();
            if (!this.ValidateCorrelation(offsetMinutes))
            {
                return;
            }

            // ビューモデルからエンティティへの変換
            var announcement = new DresscaCMS.Announcement.Infrastructures.Entities.Announcement
            {
                Id = Guid.NewGuid(),
                Category = this.announcementModel.Category,
                PostDateTime = this.announcementModel.GetPostDateTime(offsetMinutes),
                ExpireDateTime = this.announcementModel.GetExpireDateTime(offsetMinutes),
                DisplayPriority = this.announcementModel.DisplayPriority,
                CreatedAt = DateTimeOffset.UtcNow,
                ChangedAt = DateTimeOffset.UtcNow,
                IsDeleted = false,
            };

            var contents = this.announcementModel.AnnouncementContents.Select(c => new DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementContent
            {
                Id = Guid.NewGuid(),
                AnnouncementId = announcement.Id,
                LanguageCode = c.LanguageCode,
                Title = c.Title,
                Message = c.Message,
                LinkedUrl = string.IsNullOrWhiteSpace(c.LinkedUrl) ? null : c.LinkedUrl
            }).ToList();

            // ログイン中のユーザー名を取得
            var userName = await this.AuthenticationStateProvider.GetCurrentUserNameAsync();

            // アプリケーションサービスを呼び出し
            var createdId = await this.AnnouncementsService.CreateAnnouncementAndContentAsync(
                announcement,
                contents,
                userName);

            // 成功したら編集画面へ遷移
            this.NavigationManager.NavigateTo($"/announcements/{createdId}/edit");
        }
        catch (BusinessException businessEx)
        {
            // ビジネス例外発生時はメッセージを表示
            foreach (var error in businessEx.GetErrors())
            {
                this.messageStore.Add(
                    new FieldIdentifier(this.editContext.Model, string.Empty),
                    error.ErrorMessage);
            }

            this.editContext.NotifyValidationStateChanged();
        }
        finally
        {
            this.isSubmitting = false;
            this.StateHasChanged();
        }
    }

    /// <summary>
    /// 相関チェックを実行し、結果を返します。
    /// </summary>
    /// <param name="offsetMinutes">現在のタイムゾーンにおけるオフセット (分) 。</param>
    /// <returns>相関チェック結果。true: 成功、false: 失敗。</returns>
    private bool ValidateCorrelation(long offsetMinutes)
    {
        // 掲載終了日時が掲載開始日時より前かチェック
        var postDateTime = this.announcementModel.GetPostDateTime(offsetMinutes);
        var expireDateTime = this.announcementModel.GetExpireDateTime(offsetMinutes);

        if (expireDateTime.HasValue && postDateTime > expireDateTime.Value)
        {
            this.messageStore.Add(
                new FieldIdentifier(this.editContext.Model, string.Empty),
                "掲載終了日時は掲載開始日時以降に設定してください。");
            this.editContext.NotifyValidationStateChanged();
            return false;
        }

        // お知らせコンテンツが1件以上あるかチェック
        if (!this.announcementModel.AnnouncementContents.Any())
        {
            this.messageStore.Add(
                new FieldIdentifier(this.editContext.Model, string.Empty),
                "お知らせメッセージは1件以上作成してください。");
            this.editContext.NotifyValidationStateChanged();
            return false;
        }

        // 言語コードの重複チェック
        var languageCodes = this.announcementModel.AnnouncementContents.Select(c => c.LanguageCode).ToList();
        if (languageCodes.Count != languageCodes.Distinct().Count())
        {
            this.messageStore.Add(
                new FieldIdentifier(this.editContext.Model, string.Empty),
                "お知らせメッセージの言語が重複しています。");
            this.editContext.NotifyValidationStateChanged();
            return false;
        }

        return true;
    }

    /// <summary>
    /// 一覧へ戻るボタンクリック時の処理
    /// </summary>
    private void OnBackToListButtonClick()
    {
        this.NavigationManager.NavigateTo("/announcements");
    }

    /// <summary>
    ///  現在のタイムゾーンにおけるオフセットを取得します。
    /// </summary>
    /// <returns>オフセット (分) 。</returns>
    private async Task<int> GetOffsetAsync()
    {
        // ViewModelに現在のブラウザーのタイムゾーンオフセットを設定
        return await this.JS.InvokeAsync<int>("timezoneHelper.getTimezoneOffset");
    }
}
