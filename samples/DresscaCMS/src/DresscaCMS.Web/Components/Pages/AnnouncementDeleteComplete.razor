@page "/announcements/{AnnouncementId:guid}/delete-complete"
@using DresscaCMS.Announcement.ApplicationCore
@using DresscaCMS.Web.State
@using DresscaCMS.Web.ViewModels
@inject NavigationManager Navigation
@inject IStateStore StateStore

<h3>お知らせメッセージ削除完了</h3>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="30">
    <FluentBreadcrumb>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/">TOP</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ管理
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/announcements">お知らせメッセージ一覧</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ削除完了
        </FluentBreadcrumbItem>
    </FluentBreadcrumb>

    @if (announcement == null || contents == null)
    {
        <div class="loading-spinner">
            <FluentProgressRing Width="60px" />
        </div>
    }
    else
    {
        <FluentMessageBar Intent="MessageIntent.Success" Style="margin-bottom: 20px;">
            お知らせメッセージを削除しました。
        </FluentMessageBar>

        @* お知らせメッセージ削除完了・基本情報部 *@
        <FluentCard Style="padding: 20px; margin-bottom: 20px;">
            <h4>基本情報</h4>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                <div>
                    <strong>掲載日時：</strong>
                    @announcement.PostDateTime.ToString("yyyy/MM/dd HH:mm:ss") ～ @(announcement.ExpireDateTime?.ToString("yyyy/MM/dd HH:mm:ss") ?? "")
                </div>
                <div>
                    <strong>カテゴリー：</strong>
                    @(announcement.Category ?? "")
                </div>
                <div>
                    <strong>表示優先度：</strong>
                    @announcement.DisplayPriority.GetDisplayName()
                </div>
            </FluentStack>
        </FluentCard>

        @* お知らせメッセージ削除完了・お知らせコンテンツ部 *@
        <h4>お知らせコンテンツ</h4>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-bottom: 20px;">
            @foreach (var content in contents.OrderBy(c => GetLanguageOrder(Language.GetLanguageFrom(c.LanguageCode))))
            {
                <FluentCard Style="padding: 20px;">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                        <div>
                            <strong>言語：</strong>
                            @GetLanguageName(content.LanguageCode)
                        </div>
                        <div>
                            <strong>タイトル：</strong>
                            @content.Title
                        </div>
                        <div>
                            <strong>表示メッセージ：</strong>
                            @content.Message
                        </div>
                        @if (!string.IsNullOrEmpty(content.LinkedUrl))
                        {
                            <div>
                                <strong>リンク先URL：</strong>
                                <a href="@content.LinkedUrl" target="_blank">@content.LinkedUrl</a>
                            </div>
                        }
                    </FluentStack>
                </FluentCard>
            }
        </FluentStack>

        @* お知らせメッセージ削除完了・アクション部 *@
        <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
            <FluentButton Appearance="Appearance.Neutral" OnClick="@OnNavigateToListAsync">
                お知らせメッセージ管理画面へのリンク
            </FluentButton>
        </FluentStack>

        @* お知らせメッセージ削除完了・更新履歴部 *@
        @if (histories.Any())
        {
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-top: 40px;">
                <h4>更新履歴</h4>
                @foreach (var history in histories)
                {
                    <FluentAccordion>
                        <FluentAccordionItem Heading="@GetHistoryHeading(history)">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                                <div><strong>掲載開始日時：</strong>@history.PostDateTime.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                <div><strong>掲載終了日時：</strong>@(history.ExpireDateTime?.ToString("yyyy/MM/dd HH:mm:ss") ?? "")</div>
                                <div><strong>カテゴリー：</strong>@(history.Category ?? "")</div>
                                <div><strong>表示優先度：</strong>@history.DisplayPriority.GetDisplayName()</div>

                                @if (history.Contents.Any())
                                {
                                    <h5 style="margin-top: 15px;">言語別コンテンツ</h5>
                                    @foreach (var contentHistory in history.Contents)
                                    {
                                        <FluentCard Style="padding: 15px; margin-top: 10px;">
                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                                <div><strong>言語：</strong>@GetLanguageName(contentHistory.LanguageCode)</div>
                                                <div><strong>タイトル：</strong>@contentHistory.Title</div>
                                                <div><strong>メッセージ：</strong>@contentHistory.Message</div>
                                                <div><strong>リンク先URL：</strong>@(contentHistory.LinkedUrl ?? "")</div>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                }
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                }
            </FluentStack>
        }
    }
</FluentStack>

@code {

    [Parameter]
    public Guid AnnouncementId { get; set; }

    private DresscaCMS.Announcement.Infrastructures.Entities.Announcement? announcement;
    private List<DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementContent> contents = new();
    private List<DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory> histories = new();
    private LanguagePriorities languagePriority = new();

    protected override async Task OnInitializedAsync()
    {
        // 削除確認画面からの引継ぎ情報を取得
        var stateKey = $"DeletedAnnouncement_{AnnouncementId}";
        var result = await StateStore.PopAsync<DeletedAnnouncementState>(stateKey);

        if (!result.Found || result.Value == null)
        {
            // 引継ぎ情報がない場合は一覧画面へ遷移
            Navigation.NavigateTo("/announcements");
            return;
        }

        var state = result.Value;
        announcement = state.Announcement;
        contents = state.Contents;
        histories = state.Histories;
    }

    /// <summary>
    /// 履歴のヘッダー文字列を取得
    /// </summary>
    private string GetHistoryHeading(DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory history)
    {
        var operationType = history.OperationType switch
        {
            OperationType.Create => "作成",
            OperationType.Update => "更新",
            OperationType.Delete => "削除",
            _ => "不明"
        };

        return $"{history.CreatedAt:yyyy/MM/dd HH:mm:ss} - {operationType} - {history.ChangedBy}";
    }

    /// <summary>
    /// 言語コードから言語名を取得
    /// </summary>
    private string GetLanguageName(string languageCode)
    {
        return languageCode switch
        {
            "ja" => "日本語",
            "en" => "英語",
            "zh" => "中国語",
            "es" => "スペイン語",
            _ => languageCode
        };
    }

    /// <summary>
    /// 言語コードの表示順序を取得
    /// </summary>
    private int GetLanguageOrder(Language language)
    {
        var index = languagePriority.IndexOf(language);
        return index == -1 ? int.MaxValue : index;
    }

    /// <summary>
    /// 一覧画面へ遷移
    /// </summary>
    private void OnNavigateToListAsync()
    {
        Navigation.NavigateTo("/announcements");
    }
}
