@page "/announcements/{AnnouncementId:guid}/edit"
@using DresscaCMS.Announcement.ApplicationCore
@using DresscaCMS.Announcement.ApplicationCore.ApplicationServices
@using DresscaCMS.Web.ViewModels
@using DresscaCMS.Web.Extensions
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager Navigation
@inject AnnouncementsApplicationService AnnouncementsService
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>お知らせメッセージ編集</h3>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="30">
    <FluentBreadcrumb>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/">TOP</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ管理
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/announcements">お知らせメッセージ一覧</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ編集
        </FluentBreadcrumbItem>
    </FluentBreadcrumb>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <FluentProgressRing Width="60px" />
        </div>
    }
    else if (announcementModel == null)
    {
        <p>お知らせメッセージが見つかりませんでした。</p>
    }
    else
    {
        <EditForm Model="@announcementModel" OnValidSubmit="@OnSaveButtonClickAsync" FormName="AnnouncementEditForm">
            <DataAnnotationsValidator />

            @* お知らせメッセージ編集・ヘッダー部 *@
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="20">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="20">
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentLabel>掲載開始日時（日付）<span class="required">*</span></FluentLabel>
                        <FluentDatePicker @bind-Value="@announcementModel.PostDate" Placeholder="yyyy/MM/dd" />
                        <ValidationMessage For="@(() => announcementModel.PostDate)" />
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentLabel>掲載開始日時（時刻）</FluentLabel>
                        <FluentTimePicker @bind-Value="@announcementModel.PostTime" />
                    </FluentStack>
                </FluentStack>

                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="20">
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentLabel>掲載終了日時（日付）</FluentLabel>
                        <FluentDatePicker @bind-Value="@announcementModel.ExpireDate" Placeholder="yyyy/MM/dd" />
                    </FluentStack>
                    <FluentStack Orientation="Orientation.Vertical">
                        <FluentLabel>掲載終了日時（時刻）</FluentLabel>
                        <FluentTimePicker @bind-Value="@announcementModel.ExpireTime" />
                    </FluentStack>
                </FluentStack>

                <FluentStack Orientation="Orientation.Vertical">
                    <FluentLabel>カテゴリー</FluentLabel>
                    <FluentTextField @bind-Value="@announcementModel.Category" Maxlength="128" Style="width: 400px;" />
                    <ValidationMessage For="@(() => announcementModel.Category)" />
                </FluentStack>

                <FluentStack Orientation="Orientation.Vertical">
                    <FluentLabel>表示優先度<span class="required">*</span></FluentLabel>
                    <InputSelect @bind-Value="@announcementModel.DisplayPriority" class="fluent-select" style="width: 200px;">
                        <option value="@DisplayPriority.Critical">緊急</option>
                        <option value="@DisplayPriority.High">高</option>
                        <option value="@DisplayPriority.Medium">中</option>
                        <option value="@DisplayPriority.Low">低</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => announcementModel.DisplayPriority)" />
                </FluentStack>
            </FluentStack>

            @* お知らせメッセージ編集・お知らせコンテンツアクション部 *@
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10" Style="margin-top: 30px;">
                <FluentButton Appearance="Appearance.Accent" OnClick="@OnAddLanguageButtonClick">別の言語を追加</FluentButton>
            </FluentStack>

            @* お知らせメッセージ編集・お知らせコンテンツ部 *@
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="20" Style="margin-top: 20px;">
                @if (!contentModels.Any())
                {
                    <p>登録されているお知らせメッセージはありません。</p>
                }
                else
                {
                    @foreach (var content in contentModels.OrderBy(c => c.DisplayOrder))
                    {
                        <FluentCard Style="padding: 20px;">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
                                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.End">
                                    <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => OnDeleteContentButtonClick(content.Id))">
                                        <FluentIcon Value="@(new Icons.Regular.Size20.Delete())" Color="@Color.Error" />
                                        削除
                                    </FluentButton>
                                </FluentStack>

                                <FluentStack Orientation="Orientation.Vertical">
                                    <FluentLabel>言語<span class="required">*</span></FluentLabel>
                                    <InputSelect @bind-Value="@content.LanguageCode" class="fluent-select" style="width: 200px;">
                                        <option value="ja">日本語</option>
                                        <option value="en">英語</option>
                                        <option value="zh">中国語</option>
                                        <option value="es">スペイン語</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => content.LanguageCode)" />
                                </FluentStack>

                                <FluentStack Orientation="Orientation.Vertical">
                                    <FluentLabel>タイトル<span class="required">*</span></FluentLabel>
                                    <FluentTextField @bind-Value="@content.Title" Maxlength="256" Style="width: 100%;" />
                                    <ValidationMessage For="@(() => content.Title)" />
                                </FluentStack>

                                <FluentStack Orientation="Orientation.Vertical">
                                    <FluentLabel>メッセージ<span class="required">*</span></FluentLabel>
                                    <FluentTextArea @bind-Value="@content.Message" Maxlength="512" Rows="5" Style="width: 100%;" />
                                    <ValidationMessage For="@(() => content.Message)" />
                                </FluentStack>

                                <FluentStack Orientation="Orientation.Vertical">
                                    <FluentLabel>リンク先URL</FluentLabel>
                                    <FluentTextField @bind-Value="@content.LinkedUrl" Maxlength="1024" Placeholder="https://www.example.com" Style="width: 100%;" />
                                    <ValidationMessage For="@(() => content.LinkedUrl)" />
                                </FluentStack>
                            </FluentStack>
                        </FluentCard>
                    }
                }
            </FluentStack>

            @* お知らせメッセージ編集・アクション部 *@
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-top: 30px;">
                @if (!string.IsNullOrEmpty(businessErrorMessage))
                {
                    <FluentMessageBar Intent="MessageIntent.Error">
                        @businessErrorMessage
                    </FluentMessageBar>
                }

                @if (!string.IsNullOrEmpty(correlationErrorMessage))
                {
                    <FluentMessageBar Intent="MessageIntent.Error">
                        @correlationErrorMessage
                    </FluentMessageBar>
                }

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <FluentMessageBar Intent="MessageIntent.Success">
                        @successMessage
                    </FluentMessageBar>
                }

                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                    <FluentButton Type="ButtonType.Submit" Appearance="Appearance.Accent" Disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <FluentProgressRing Width="20px" />
                        }
                        お知らせメッセージの保存
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" OnClick="@OnNavigateToDeleteConfirmAsync">
                        お知らせメッセージの削除
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Neutral" OnClick="@OnBackToListButtonClickAsync">
                        お知らせメッセージ管理画面へ戻る
                    </FluentButton>
                </FluentStack>
            </FluentStack>
        </EditForm>

        @* お知らせメッセージ編集・更新履歴部 *@
        @if (histories.Any())
        {
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-top: 40px;">
                <h4>更新履歴</h4>
                @foreach (var history in histories)
                {
                    <FluentAccordion>
                        <FluentAccordionItem Heading="@GetHistoryHeading(history)">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                                <div><strong>掲載開始日時：</strong>@history.PostDateTime.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                <div><strong>掲載終了日時：</strong>@(history.ExpireDateTime?.ToString("yyyy/MM/dd HH:mm:ss") ?? "")</div>
                                <div><strong>カテゴリー：</strong>@(history.Category ?? "")</div>
                                <div><strong>表示優先度：</strong>@history.DisplayPriority.GetDisplayName()</div>

                                @if (history.Contents.Any())
                                {
                                    <h5 style="margin-top: 15px;">言語別コンテンツ</h5>
                                    @foreach (var contentHistory in history.Contents)
                                    {
                                        <FluentCard Style="padding: 15px; margin-top: 10px;">
                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                                <div><strong>言語：</strong>@GetLanguageName(contentHistory.LanguageCode)</div>
                                                <div><strong>タイトル：</strong>@contentHistory.Title</div>
                                                <div><strong>メッセージ：</strong>@contentHistory.Message</div>
                                                <div><strong>リンク先URL：</strong>@(contentHistory.LinkedUrl ?? "")</div>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                }
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                }
            </FluentStack>
        }
    }
</FluentStack>

@code {
    [Parameter]
    public Guid AnnouncementId { get; set; }

    private AnnouncementViewModel? announcementModel;
    private List<AnnouncementContentViewModel> contentModels = new();
    private List<DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory> histories = new();
    private string? businessErrorMessage;
    private string? correlationErrorMessage;
    private string? successMessage;
    private bool isSubmitting = false;
    private bool isLoading = true;

    private readonly string[] languagePriority = ["ja", "en", "zh", "es"];

    protected override async Task OnInitializedAsync()
    {
        await LoadAnnouncementDataAsync();
    }

    /// <summary>
    /// お知らせメッセージデータを読み込む
    /// </summary>
    private async Task LoadAnnouncementDataAsync()
    {
        isLoading = true;
        try
        {
            var result = await AnnouncementsService.GetAnnouncementAndHistoriesByIdAsync(AnnouncementId);

            if (result == null)
            {
                // Not Found
                announcementModel = null;
                return;
            }

            // AnnouncementViewModel への変換
            announcementModel = new AnnouncementViewModel
            {
                Id = result.Announcement.Id,
                Category = result.Announcement.Category,
                DisplayPriority = result.Announcement.DisplayPriority
            };
            announcementModel.SetPostDateTime(result.Announcement.PostDateTime);
            announcementModel.SetExpireDateTime(result.Announcement.ExpireDateTime);

            // AnnouncementContentViewModel への変換
            contentModels = result.Contents.Select(c =>
            {
                var displayOrder = Array.IndexOf(languagePriority, c.LanguageCode);
                return new AnnouncementContentViewModel
                {
                    Id = c.Id,
                    AnnouncementId = c.AnnouncementId,
                    LanguageCode = c.LanguageCode,
                    Title = c.Title,
                    Message = c.Message,
                    LinkedUrl = c.LinkedUrl,
                    DisplayOrder = displayOrder == -1 ? int.MaxValue : displayOrder
                };
            }).ToList();

            // 履歴データの設定
            histories = result.Histories.ToList();
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// 別の言語を追加ボタンクリック時の処理
    /// </summary>
    private void OnAddLanguageButtonClick()
    {
        var nextLanguage = GetNextLanguageCode();
        AddContentWithLanguage(nextLanguage);
    }

    /// <summary>
    /// 次に追加すべき言語コードを取得
    /// </summary>
    private string GetNextLanguageCode()
    {
        var existingLanguages = contentModels.Select(c => c.LanguageCode).ToHashSet();

        var lang = languagePriority.FirstOrDefault(l => !existingLanguages.Contains(l));

        if(lang != null)
        {
            return lang;
        }

        // 全ての言語が追加済みの場合は日本語を返す
        return "ja";
    }

    /// <summary>
    /// 指定された言語コードでコンテンツを追加
    /// </summary>
    private void AddContentWithLanguage(string languageCode)
    {
        var displayOrder = Array.IndexOf(languagePriority, languageCode);
        if (displayOrder == -1)
        {
            displayOrder = int.MaxValue;
        }

        var newContent = new AnnouncementContentViewModel
        {
            Id = Guid.Empty,
            AnnouncementId = AnnouncementId,
            LanguageCode = languageCode,
            DisplayOrder = displayOrder
        };

        contentModels.Add(newContent);
    }

    /// <summary>
    /// コンテンツ削除ボタンクリック時の処理
    /// </summary>
    private void OnDeleteContentButtonClick(Guid contentId)
    {
        var content = contentModels.FirstOrDefault(c => c.Id == contentId);
        if (content != null)
        {
            contentModels.Remove(content);
        }
    }

    /// <summary>
    /// 保存ボタンクリック時の処理
    /// </summary>
    private async Task OnSaveButtonClickAsync(EditContext editContext)
    {
        businessErrorMessage = null;
        correlationErrorMessage = null;
        successMessage = null;

        // 相関チェック
        if (!ValidateCorrelation())
        {
            return;
        }

        isSubmitting = true;
        try
        {
            // ビューモデルからエンティティへの変換
            var postDateTime = announcementModel!.GetPostDateTime();
            if (!postDateTime.HasValue)
            {
                correlationErrorMessage = "掲載開始日時を入力してください。";
                return;
            }

            var announcement = new DresscaCMS.Announcement.Infrastructures.Entities.Announcement
            {
                Id = announcementModel.Id,
                Category = announcementModel.Category,
                PostDateTime = postDateTime.Value,
                ExpireDateTime = announcementModel.GetExpireDateTime(),
                DisplayPriority = announcementModel.DisplayPriority,
                CreatedAt = DateTimeOffset.UtcNow,
                ChangedAt = DateTimeOffset.UtcNow,
                IsDeleted = false
            };

            var contents = contentModels.Select(c => new DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementContent
            {
                Id = c.Id,
                AnnouncementId = AnnouncementId,
                LanguageCode = c.LanguageCode,
                Title = c.Title,
                Message = c.Message,
                LinkedUrl = string.IsNullOrWhiteSpace(c.LinkedUrl) ? null : c.LinkedUrl
            }).ToList();

            // ログイン中のユーザー名を取得
            var userName = await AuthenticationStateProvider.GetCurrentUserNameAsync();

            // アプリケーションサービスを呼び出し
            await AnnouncementsService.UpdateAnnouncementAndContentAsync(
                announcement,
                contents,
                userName);

            // 成功メッセージ表示
            successMessage = "お知らせメッセージを保存しました。";

            // データを再読み込み
            await LoadAnnouncementDataAsync();
        }
        finally
        {
            isSubmitting = false;
        }
    }

    /// <summary>
    /// 相関チェックを実行
    /// </summary>
    private bool ValidateCorrelation()
    {
        // 掲載終了日時が掲載開始日時より前かチェック
        var postDateTime = announcementModel?.GetPostDateTime();
        var expireDateTime = announcementModel?.GetExpireDateTime();

        if ((postDateTime.HasValue && expireDateTime.HasValue) && (postDateTime.Value > expireDateTime.Value))
        {
            correlationErrorMessage = "掲載終了日時は掲載開始日時以降に設定してください。";
            return false;
        }

        // お知らせコンテンツが1件以上あるかチェック
        if (!contentModels.Any())
        {
            correlationErrorMessage = "お知らせメッセージは1件以上作成してください。";
            return false;
        }

        // 言語コードの重複チェック
        var languageCodes = contentModels.Select(c => c.LanguageCode).ToList();
        if (languageCodes.Count != languageCodes.Distinct().Count())
        {
            correlationErrorMessage = "お知らせメッセージの言語が重複しています。";
            return false;
        }

        return true;
    }

    /// <summary>
    /// 一覧へ戻るボタンクリック時の処理
    /// </summary>
    private void OnBackToListButtonClickAsync()
    {
        Navigation.NavigateTo("/announcements");
    }

    /// <summary>
    /// 削除確認画面へ遷移
    /// </summary>
    private void OnNavigateToDeleteConfirmAsync()
    {
        Navigation.NavigateTo($"/announcements/{AnnouncementId}/delete-confirm");
    }

    /// <summary>
    /// 履歴のヘッダー文字列を取得
    /// </summary>
    private string GetHistoryHeading(DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory history)
    {
        var operationType = history.OperationType switch
        {
            OperationType.Create => "作成",
            OperationType.Update => "更新",
            OperationType.Delete => "削除",
            _ => "不明"
        };

        return $"{history.CreatedAt:yyyy/MM/dd HH:mm:ss} - {operationType} - {history.ChangedBy}";
    }

    /// <summary>
    /// 言語コードから言語名を取得
    /// </summary>
    private string GetLanguageName(string languageCode)
    {
        return languageCode switch
        {
            "ja" => "日本語",
            "en" => "英語",
            "zh" => "中国語",
            "es" => "スペイン語",
            _ => languageCode
        };
    }
}
