@page "/announcements/{AnnouncementId:guid}/delete-confirm"

@using DresscaCMS.Announcement.ApplicationCore
@using DresscaCMS.Announcement.ApplicationCore.ApplicationServices
@using DresscaCMS.Web.Extensions
@using DresscaCMS.Web.State
@using Microsoft.AspNetCore.Components.Authorization

@inject AnnouncementsApplicationService AnnouncementsService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStateStore StateStore
@inject NavigationManager NavigationManager

<h3>お知らせメッセージ削除確認</h3>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="30">
    <FluentBreadcrumb>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/">TOP</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ管理
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            <FluentNavLink Href="/announcements">お知らせメッセージ一覧</FluentNavLink>
            <FluentIcon Value="@(new Icons.Regular.Size20.ChevronRight())" Color="@Color.Neutral" Slot="separator" Class="bread-crumb-separator" />
        </FluentBreadcrumbItem>
        <FluentBreadcrumbItem>
            お知らせメッセージ削除確認
        </FluentBreadcrumbItem>
    </FluentBreadcrumb>

    @if (this.isLoading)
    {
        <div class="loading-spinner">
            <FluentProgressRing Width="60px" />
        </div>
    }
    else if (this.announcement == null)
    {
        <p>お知らせメッセージが見つかりませんでした。</p>
    }
    else
    {
        <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-bottom: 20px;">
            このお知らせメッセージを削除してもよろしいですか？この操作は取り消せません。
        </FluentMessageBar>

        @* お知らせメッセージ削除確認・基本情報部 *@
        <FluentCard Style="padding: 20px; margin-bottom: 20px;">
            <h4>基本情報</h4>
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                <div>
                    <strong>掲載日時：</strong>
                    @this.announcement.PostDateTime.ToString("yyyy/MM/dd HH:mm:ss") ～ @(this.announcement.ExpireDateTime?.ToString("yyyy/MM/dd HH:mm:ss") ?? "")
                </div>
                <div>
                    <strong>カテゴリー：</strong>
                    @(this.announcement.Category ?? "")
                </div>
                <div>
                    <strong>表示優先度：</strong>
                    @this.announcement.DisplayPriority.GetDisplayName()
                </div>
            </FluentStack>
        </FluentCard>

        @* お知らせメッセージ削除確認・お知らせコンテンツ部 *@
        <h4>お知らせコンテンツ</h4>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-bottom: 20px;">
            @foreach (var content in this.contents.OrderBy(c => this.languagePriorities.GetDisplayOrder(Language.GetLanguageFrom(c.LanguageCode))))
            {
                <FluentCard Style="padding: 20px;">
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                        <div>
                            <strong>言語：</strong>
                            @this.GetLanguageName(content.LanguageCode)
                        </div>
                        <div>
                            <strong>タイトル：</strong>
                            @content.Title
                        </div>
                        <div>
                            <strong>表示メッセージ：</strong>
                            @content.Message
                        </div>
                        @if (!string.IsNullOrEmpty(content.LinkedUrl))
                        {
                            <div>
                                <strong>リンク先URL：</strong>
                                @if (content.LinkedUrl.StartsWith("http"))
                                {
                                    <a href="@content.LinkedUrl" target="_blank">@content.LinkedUrl</a>
                                }
                                else
                                {
                                    <span>@content.LinkedUrl</span>
                                }
                            </div>
                        }
                    </FluentStack>
                </FluentCard>
            }
        </FluentStack>

        @* お知らせメッセージ削除確認・アクション部 *@
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="15">
            @if (!string.IsNullOrEmpty(this.errorMessage))
            {
                <FluentMessageBar Intent="MessageIntent.Error">
                    @this.errorMessage
                </FluentMessageBar>
            }

            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="10">
                <FluentButton Appearance="Appearance.Accent" OnClick="@this.OnDeleteButtonClickAsync" Disabled="@this.isDeleting">
                    @if (this.isDeleting)
                    {
                        <FluentProgressRing Width="20px" />
                    }
                    お知らせメッセージ削除
                </FluentButton>
                <FluentButton Appearance="Appearance.Neutral" OnClick="@this.OnNavigateToEdit">
                    お知らせメッセージ編集画面へのリンク
                </FluentButton>
                <FluentButton Appearance="Appearance.Neutral" OnClick="@this.OnNavigateToList">
                    お知らせメッセージ管理画面へのリンク
                </FluentButton>
            </FluentStack>
        </FluentStack>

        @* お知らせメッセージ削除確認・更新履歴部 *@
        @if (this.histories.Any())
        {
            <FluentStack Orientation="Orientation.Vertical" VerticalGap="15" Style="margin-top: 40px;">
                <h4>更新履歴</h4>
                @foreach (var history in this.histories)
                {
                    <FluentAccordion>
                        <FluentAccordionItem Heading="@this.GetHistoryHeading(history)">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="10">
                                <div><strong>掲載開始日時：</strong>@history.PostDateTime.ToString("yyyy/MM/dd HH:mm:ss")</div>
                                <div><strong>掲載終了日時：</strong>@(history.ExpireDateTime?.ToString("yyyy/MM/dd HH:mm:ss") ?? "")</div>
                                <div><strong>カテゴリー：</strong>@(history.Category ?? "")</div>
                                <div><strong>表示優先度：</strong>@history.DisplayPriority.GetDisplayName()</div>

                                @if (history.Contents.Any())
                                {
                                    <h5 style="margin-top: 15px;">言語別コンテンツ</h5>
                                    @foreach (var contentHistory in history.Contents)
                                    {
                                        <FluentCard Style="padding: 15px; margin-top: 10px;">
                                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                                <div><strong>言語：</strong>@this.GetLanguageName(contentHistory.LanguageCode)</div>
                                                <div><strong>タイトル：</strong>@contentHistory.Title</div>
                                                <div><strong>メッセージ：</strong>@contentHistory.Message</div>
                                                <div><strong>リンク先URL：</strong>@(contentHistory.LinkedUrl ?? "")</div>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                }
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                }
            </FluentStack>
        }
    }
</FluentStack>

@code {
    [Parameter]
    public Guid AnnouncementId { get; set; }

    private readonly LanguagePriorities languagePriorities = new();
    private DresscaCMS.Announcement.Infrastructures.Entities.Announcement? announcement;
    private List<DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementContent> contents = new();
    private List<DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory> histories = new();
    private string? errorMessage;
    private bool isDeleting = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await this.LoadAnnouncementDataAsync();
    }

    /// <summary>
    /// お知らせメッセージデータを読み込む
    /// </summary>
    private async Task LoadAnnouncementDataAsync()
    {
        this.isLoading = true;
        try
        {
            var result = await this.AnnouncementsService.GetAnnouncementAndHistoriesByIdAsync(this.AnnouncementId);

            if (result == null)
            {
                // Not Found
                this.announcement = null;
                return;
            }

            this.announcement = result.Announcement;
            this.contents = result.Contents.ToList();
            this.histories = result.Histories.ToList();
        }
        finally
        {
            this.isLoading = false;
        }
    }

    /// <summary>
    /// 削除ボタンクリック時の処理
    /// </summary>
    private async Task OnDeleteButtonClickAsync()
    {
        this.errorMessage = null;
        this.isDeleting = true;

        try
        {
            // ログイン中のユーザー名を取得
            var userName = await this.AuthenticationStateProvider.GetCurrentUserNameAsync();

            // アプリケーションサービスを呼び出し
            await this.AnnouncementsService.DeleteAnnouncementAndContentAsync(
                this.AnnouncementId,
                userName);

            // 削除完了画面への引継ぎ情報を保存
            var stateKey = $"DeletedAnnouncement_{this.AnnouncementId}";
            var state = new DeletedAnnouncementState
            {
                Announcement = this.announcement!,
                Contents = this.contents,
                Histories = this.histories
            };
            await this.StateStore.SetAsync(stateKey, state);

            // 削除完了画面へ遷移
            this.NavigationManager.NavigateTo($"/announcements/{this.AnnouncementId}/delete-complete");
        }
        finally
        {
            this.isDeleting = false;
        }
    }

    /// <summary>
    /// 履歴のヘッダー文字列を取得
    /// </summary>
    private string GetHistoryHeading(DresscaCMS.Announcement.Infrastructures.Entities.AnnouncementHistory history)
    {
        var operationType = history.OperationType switch
        {
            OperationType.Create => "作成",
            OperationType.Update => "更新",
            OperationType.Delete => "削除",
            _ => "不明"
        };

        return $"{history.CreatedAt:yyyy/MM/dd HH:mm:ss} - {operationType} - {history.ChangedBy}";
    }

    /// <summary>
    /// 言語コードから言語名を取得
    /// </summary>
    private string GetLanguageName(string languageCode)
        => Language.GetLanguageFrom(languageCode).DisplayName;

    /// <summary>
    /// 編集画面へ遷移
    /// </summary>
    private void OnNavigateToEdit()
    {
        this.NavigationManager.NavigateTo($"/announcements/{this.AnnouncementId}/edit");
    }

    /// <summary>
    /// 一覧画面へ遷移
    /// </summary>
    private void OnNavigateToList()
    {
        this.NavigationManager.NavigateTo("/announcements");
    }
}
